title User registration

actor Unregistered User
participant MainActivity
participant SigningActivity
participant eMSP_RegistrationService
database Users DBMS
participant PaymentAPI



activate MainActivity

Unregistered User->MainActivity:Open APP

MainActivity->MainActivity:isLogged()

activate MainActivity
MainActivity->>SigningActivity:StartSigningActivity
deactivate MainActivity
deactivate MainActivity

activate SigningActivity
SigningActivity-->Unregistered User: ShowInterface



Unregistered User->SigningActivity:Click register button

Unregistered User<--SigningActivity:ShowRegistrationForm


Unregistered User->SigningActivity:Submit data

SigningActivity->SigningActivity:ValidateInput()

alt isValid

	SigningActivity->eMSP_RegistrationService:newUser(Data)
	
	activate eMSP_RegistrationService
	eMSP_RegistrationService->Users DBMS:inserIncompleteUser(Data)
	activate Users DBMS


	alt User inserted

	Users DBMS-->eMSP_RegistrationService:Completed
    deactivate Users DBMS

	eMSP_RegistrationService->eMSP_RegistrationService:verifyMail(Mail)
    
    
	
    
    	
    eMSP_RegistrationService->PaymentAPI:checkPaymentMethod
    activate PaymentAPI
   PaymentAPI-->eMSP_RegistrationService:ValidPaymentMethod
    deactivate PaymentAPI
    
    eMSP_RegistrationService->Users DBMS:ActivateUser
    activate Users DBMS
    Users DBMS-->eMSP_RegistrationService:Activated
    deactivate Users DBMS
    eMSP_RegistrationService-->SigningActivity:OK
    deactivate eMSP_RegistrationService
    SigningActivity-->Unregistered User:Successfull signin
    
    SigningActivity->MainActivity:StartMainActivity
    deactivate SigningActivity
    activate MainActivity
    MainActivity-->Unregistered User:Show
    space
    deactivate MainActivity
    
   

	else User already registered
    activate Users DBMS
    Users DBMS-->eMSP_RegistrationService:FailedInsertion
	deactivate Users DBMS
    activate eMSP_RegistrationService
    eMSP_RegistrationService-->SigningActivity:Failed
    deactivate eMSP_RegistrationService
    activate SigningActivity
    SigningActivity-->Unregistered User:Failed
    space
    deactivate SigningActivity
    
    
	end
else notValid

activate SigningActivity
SigningActivity-->Unregistered User:Invalid data
space 
deactivate SigningActivity
end
