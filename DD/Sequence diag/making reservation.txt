title Making a reservation

actor Registered User
participant MainActivity
participant CPO_API
participant CPMS_InfoService
participant ReservationActivity
participant CPMS_ReservationService

database Reservations_Database
participant PaymentAPI

activate MainActivity

Registered User->MainActivity:Open APP

MainActivity->MainActivity:isLogged()

activate MainActivity
space
deactivate MainActivity

MainActivity-->Registered User: ShowMap

alt User wants to define search location
	Registered User->MainActivity:Search string
    MainActivity->MainActivity:UpdatePosition(search_string)
    
else Book NOW option
	Registered User->MainActivity:Select Book NOW
	MainActivity->MainActivity:LocateUser()
	
end

MainActivity->CPO_API:RequestCS(loc)
activate CPO_API



CPO_API-->MainActivity:CSList
deactivate CPO_API

space

activate MainActivity
loop for each CS in list
MainActivity->CPMS_InfoService:RequestInfo()
activate CPMS_InfoService
alt Response from CPMS received
CPMS_InfoService -->MainActivity:CSInfo

MainActivity->MainActivity:InsertCSMarkers(cs)
end

deactivate CPMS_InfoService
end
deactivate MainActivity


MainActivity-->Registered User:ShowUpdatedMap

Registered User->MainActivity:Select CS
MainActivity-->Registered User:Show CS info

Registered User->MainActivity:Click "Book for charge"
MainActivity->ReservationActivity:StartReservationActivity
activate ReservationActivity
deactivate MainActivity

ReservationActivity-->Registered User:Show reservation form
Registered User->ReservationActivity:Fill form data

ReservationActivity->ReservationActivity:ValidateInput()

ReservationActivity->CPMS_ReservationService: RequestReservation(date,info)
activate CPMS_ReservationService

CPMS_ReservationService->Reservations_Database:insert(reservation)
activate Reservations_Database
alt correctly inserted

	Reservations_Database-->CPMS_ReservationService: InsertionPerformed
    deactivate Reservations_Database
    CPMS_ReservationService-->ReservationActivity: ReservationGranted
    deactivate CPMS_ReservationService
    ReservationActivity->ReservationActivity:CalculateFee
    
    ReservationActivity->PaymentAPI:RequestPayment
    activate PaymentAPI
    
    alt Payment Completed
    	PaymentAPI-->ReservationActivity:Payment Confirmed
        deactivate PaymentAPI
        ReservationActivity-->Registered User: Show reservation success
        ReservationActivity->MainActivity:StartMainActivity
        deactivate ReservationActivity
        activate MainActivity
        MainActivity-->Registered User: Show main page
        space 
        deactivate MainActivity
    else Payment rejected
    	activate PaymentAPI
        activate ReservationActivity
        PaymentAPI-->ReservationActivity:Payment rejected
        deactivate PaymentAPI
        ReservationActivity->Reservations_Database:remove(res)
        activate Reservations_Database
        Reservations_Database-->ReservationActivity:Confirmation
        deactivate Reservations_Database
        ReservationActivity-->Registered User:Notify Reservation Failed (payment rejected)
    	space
        deactivate ReservationActivity
        
    end
	
else Timeframe not available
	activate Reservations_Database
    activate CPMS_ReservationService
    activate ReservationActivity
    Reservations_Database-->CPMS_ReservationService: Reservation rejected
    deactivate Reservations_Database
    CPMS_ReservationService-->ReservationActivity: Reservation rejected
    deactivate CPMS_ReservationService
    ReservationActivity-->Registered User:Notify Reservation Failed (Reservation rejected)
    
end











