title autonomous energy management

participant CPMS_powerManagerService
participant DSOs_API
participant BatteryPack_API

activate CPMS_powerManagerService
CPMS_powerManagerService->>DSOs_API:periodicCostCheck
activate DSOs_API
DSOs_API-->CPMS_powerManagerService:prices
deactivate DSOs_API
alt new prices better than old ones 
	CPMS_powerManagerService->CPMS_powerManagerService:selectBetterOne
	CPMS_powerManagerService->DSOs_API:stipulateNewContract
    activate DSOs_API
	DSOs_API-->CPMS_powerManagerService:done
    deactivate DSOs_API
end

CPMS_powerManagerService->BatteryPack_API:getBatteryLevel
activate BatteryPack_API
BatteryPack_API-->CPMS_powerManagerService:batteryLevel
alt Not full
	CPMS_powerManagerService->BatteryPack_API:getStoredEnergyPrice
	BatteryPack_API-->CPMS_powerManagerService:storedEnergyPrice
    deactivate BatteryPack_API
    
    alt Current price lower than stored one or is night time
        CPMS_powerManagerService->BatteryPack_API:fillBatteries
        activate BatteryPack_API 
        #BatteryPack_API-->CPMS_powerManagerService:processStart
        space
        space
        BatteryPack_API-->CPMS_powerManagerService:processEnd
        deactivate BatteryPack_API
    end    
end
